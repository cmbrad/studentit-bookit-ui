<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/platinum-sw/platinum-sw-register.html">
<link rel="import" href="../../bower_components/platinum-sw/platinum-sw-cache.html">

<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-media-query/iron-media-query.html">

<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../../bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="../../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">

<link rel="import" href="../location-card/location-card.html">
<link rel="import" href="../action-card/action-card.html">

<link rel="import" href="../bookit-data/bookit-data.html">

<dom-module id="findit-app">
	<template>
		<style>
			#header-text {
				font-size: 20px;
				font-weight: 400;
				cursor: default;
			}
			
			::-webkit-scrollbar {
				width: 0px;
				height: 0px;
				/* remove scrollbar space */
				background: transparent;
				/* optional: just make scrollbar invisible */
			}
			
			#page-content {
				box-sizing: border-box;
				width: 100vw;
				height: 100%;
				overflow-x: hidden;
				overflow-y: auto;
				padding: 0 6px 0 6px;
				background: #F5F5F5;
			}
			
			.locations-heading {
				padding-top: 12px;
			}
			
			.locations-container {
				width: 100%;
				display: flex;
				flex-wrap: wrap;
			}
			
			.locations-container location-card {
				margin-bottom: 6px;
			}
			
			.actions-container {
				width: 100%;
				padding-top: 6px;
				display: flex;
				overflow-x: scroll;
				overflow-y: hidden;

				margin-bottom: 12px;
			}

			location-card {
				margin: 0 3px 0 3px;
			}
			
			@media screen and (min-width: 796px) {
				#page-content {
					padding: 24px 48px 0 48px;
				}
			}
		</style>

		<bookit-data loading="[[loading]]"></bookit-data>

		<iron-media-query query="(max-width: 796px)" query-matches="{{paddingCollapsed}}"></iron-media-query>

		<paper-drawer-panel force-narrow>
			<paper-header-panel drawer></paper-header-panel>
			<paper-header-panel main>
				<paper-toolbar>
					<paper-icon-button icon="menu" paper-drawer-toggle></paper-icon-button>
					<div id="header-text" class="flex">FindIT</div>
				</paper-toolbar>

				<div id="page-content">
					<div class="actions-container">
						<action-card image="../../img/action/computers.jpg" heading="Nearby Computers"></action-card>
						<action-card image="../../img/action/project_room.jpg" heading="Nearby Project Rooms"></action-card>
						<action-card image="../../img/action/bookit.jpg" heading="BookIT"></action-card>
						<action-card image="../../img/action/studentit.jpg" heading="StudentIT"></action-card>
					</div>

					<h3 class="locations-heading" hidden$="[[paddingCollapsed]]">Locations</h3>
					<div class="locations-container">
						<template is="dom-repeat" items="[[stateData]]">
							<location-card heading="[[item.name]]" image="../../img/library/[[locationNameToImage(item.name)]]"
								available-computers="[[item.available_computers]]" available-rooms="[[item.available_rooms]]">
							</location-card>
						</template>
					</div>
				</div>
			</paper-header-panel>
		</paper-drawer-panel>

		<platinum-sw-register auto-register>
			<platinum-sw-cache></platinum-sw-cache>
		</platinum-sw-register>
	</template>

	<script>
    Polymer({

      is: 'findit-app',

			attached: function() {
				this._setLocationCardSize();
			},

      ready: function() {
        document.querySelector('bookit-data').addEventListener('state-data-updated', function(e) {
          this.stateData = e.detail.data;
        }.bind(this));

				window.addEventListener('resize', function(e) {
					this._setLocationCardSize();
				}.bind(this));
      },

      properties: {
        stateData: {
          type: Array,
          notify: true
        },
      },

      locationNameToImage: function(name) {
        var nameDict = {
          'Architecture': 'architecture.jpg',
          'Baillieu': 'baillieu.jpg',
          'Brownless': 'brownless.jpg',
          'Burnley': 'burnley.jpg',
          'ERC': 'eastern_resource_center.jpg',
          'Frank Tate': 'frank_tate.jpg',
          'Giblin Eunson': 'giblin_eunson.jpg',
          'Law': 'law.jpg',
          'Lenton Parr': 'lenton_parr.jpg',
          'Werribee - Vet Sci': 'werribee.jpg',
        }

        return name in nameDict ? nameDict[name] : 'default.jpg';
      },

			_setLocationCardSize: function() {
					var width = 220;
					var height = 160;

					var outerPadding = this.paddingCollapsed ? 12 : 96;
					// Add 6 for margin between cards
					var extra = this.calcCardSize(window.innerWidth, outerPadding, width + 6);

					var totalWidth = width + extra;
					var totalHeight = height;
					
					this.style.width = 'auto';
					this.customStyle['--paper-card-header-image'] = 'width: ' + String(totalWidth) + 'px; height: ' + String(totalHeight) + 'px; filter: brightness(60%);';

					this.updateStyles();
			},

			calcCardSize: function(windowWidth, outerPadding, cardWidth) {
					var availableSpace = windowWidth - outerPadding;
					var cardsPerRow = Math.floor(availableSpace / cardWidth);
					// looks like something somewhere isn't rounding properly.
					// Take off 1 to be safe
					var emptySpace = availableSpace % cardWidth - 1;

					return Math.floor(emptySpace / cardsPerRow);
			}
    });
  </script>
</dom-module>